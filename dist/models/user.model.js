"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bcryptjs_1 = __importDefault(require("bcryptjs"));
const mongoose_1 = __importDefault(require("mongoose"));
const validator_1 = __importDefault(require("validator"));
const mail_config_1 = __importDefault(require("../config/mail.config"));
const workload_controller_1 = __importDefault(require("../controllers/workload/workload.controller"));
const userSchema = new mongoose_1.default.Schema({
    userId: {
        type: String,
        unique: true,
    },
    password: {
        type: String,
    },
    email: {
        type: String,
        required: true,
        unique: true,
        lowercase: true,
        validate: (value) => {
            return validator_1.default.isEmail(value);
        },
    },
    firstName: {
        type: String,
    },
    lastName: {
        type: String,
    },
    photoUrl: {
        type: String,
    },
    disciplineIds: [
        {
            type: String,
            ref: "Discipline",
        },
    ],
    positionId: {
        type: String,
        ref: "Position",
    },
    departmentId: {
        type: String,
        ref: "Department",
    },
    gender: {
        type: String,
    },
    nationality: {
        type: String,
    },
    workFocusName: {
        type: String,
        default: "Balanced",
        ref: "WorkFocus",
    },
    createdAt: {
        type: Date,
    },
    updatedAt: {
        type: Date,
    },
}, {
    timestamps: true,
});
// VIRTUALS
userSchema.virtual("disciplines", {
    ref: "Discipline",
    localField: "disciplineIds",
    foreignField: "disciplineId",
});
userSchema.virtual("position", {
    ref: "Position",
    localField: "positionId",
    foreignField: "positionId",
    justOne: true,
});
userSchema.virtual("workFocus", {
    ref: "WorkFocus",
    localField: "workFocusName",
    foreignField: "name",
    justOne: true,
});
userSchema.virtual("workFocus", {
    ref: "WorkFocus",
    localField: "workFocusName",
    foreignField: "name",
    justOne: true,
});
userSchema.virtual("department", {
    ref: "Department",
    localField: "departmentId",
    foreignField: "departmentId",
    justOne: true,
});
userSchema.virtual("full").get(function () {
    return (this.userId +
        "." +
        this.email +
        "." +
        this.firstName +
        "." +
        this.lastName +
        "." +
        this.photoUrl +
        "." +
        this.workFocusName +
        "." +
        this.disciplineId +
        "." +
        this.positionId +
        "." +
        this.gender +
        "." +
        this.nationality);
});
// HOOKS
// Pre-hook to hash password. Make sure to use function and not arrow (lexical 'this' problem)
userSchema.pre("save", function () {
    return __awaiter(this, void 0, void 0, function* () {
        const user = this;
        // Generate default Work Focus
        user.workFocusName = "Balanced";
        // Generate random password
        user.password = Math.random().toString(36).slice(-8);
        // Prepare and send user account mail
        const mailOptions = {
            from: "c4mahlangu@gmail.com",
            to: user.email,
            subject: "Eworkload Credentials",
            html: `<p>Welcome to the Eworkload system. Please find default credentials below</p>
          <p>User ID: ${user.userId}</p>
          <p>Password: ${user.password}</p>
          <br>
          <p>Autogenerated password may be changed from the user profile at any time.</p>
          <p>Kind regards</p>
          <p>Administrator</p>`, // plain text body
        };
        console.log("Mail options", mailOptions);
        yield mail_config_1.default.sendMail(mailOptions, (err, info) => {
            if (err)
                console.log(err);
            else
                console.log(info);
        });
        // Generate salt and hash password
        const password = user.password;
        const saltRounds = 10;
        const salt = bcryptjs_1.default.genSaltSync(saltRounds);
        const hash = bcryptjs_1.default.hashSync(password, salt);
        user.password = hash;
        // Initialize workloads
        yield workload_controller_1.default.initializeWorkloads(user.userId);
    });
});
// INSTANCE METHODS
// Ensure correct password
userSchema.methods.isValidPassword = (password) => __awaiter(void 0, void 0, void 0, function* () {
    const user = this;
    // Hash sent password and compare with db hash
    const compare = yield bcryptjs_1.default.compare(password, user.password, (err, res) => {
        console.log(err);
    });
    return compare;
});
const User = mongoose_1.default.model("User", userSchema);
exports.default = User;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL21vZGVscy91c2VyLm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsd0RBQThCO0FBRTlCLHdEQUFnQztBQUNoQywwREFBa0M7QUFFbEMsd0VBQWdEO0FBQ2hELHNHQUE2RTtBQUU3RSxNQUFNLFVBQVUsR0FBRyxJQUFJLGtCQUFRLENBQUMsTUFBTSxDQUNwQztJQUNFLE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxNQUFNO1FBQ1osTUFBTSxFQUFFLElBQUk7S0FDYjtJQUNELFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxNQUFNO0tBQ2I7SUFDRCxLQUFLLEVBQUU7UUFDTCxJQUFJLEVBQUUsTUFBTTtRQUNaLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTSxFQUFFLElBQUk7UUFDWixTQUFTLEVBQUUsSUFBSTtRQUNmLFFBQVEsRUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQ3ZCLE9BQU8sbUJBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEMsQ0FBQztLQUNGO0lBQ0QsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLE1BQU07S0FDYjtJQUNELFFBQVEsRUFBRTtRQUNSLElBQUksRUFBRSxNQUFNO0tBQ2I7SUFDRCxRQUFRLEVBQUU7UUFDUixJQUFJLEVBQUUsTUFBTTtLQUNiO0lBQ0QsYUFBYSxFQUFFO1FBQ2I7WUFDRSxJQUFJLEVBQUUsTUFBTTtZQUNaLEdBQUcsRUFBRSxZQUFZO1NBQ2xCO0tBQ0Y7SUFDRCxVQUFVLEVBQUU7UUFDVixJQUFJLEVBQUUsTUFBTTtRQUNaLEdBQUcsRUFBRSxVQUFVO0tBQ2hCO0lBQ0QsWUFBWSxFQUFFO1FBQ1osSUFBSSxFQUFFLE1BQU07UUFDWixHQUFHLEVBQUUsWUFBWTtLQUNsQjtJQUNELE1BQU0sRUFBRTtRQUNOLElBQUksRUFBRSxNQUFNO0tBQ2I7SUFDRCxXQUFXLEVB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